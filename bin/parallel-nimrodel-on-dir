#!/bin/bash

# parallel-nimrodel-on-dir jobs input-dir output-dir

# Assuming input-dir consists of subdirectories, run several copies of
# nimrodel simultaneously processing these libraries.
#
# requires GNU parallel

. "${0%/*}/env"

if [ $# -lt 3 ]; then
    echo >&2 "Usage: $0 jobs input-dir output-dir"
    exit 1
fi

JOBS=$1; shift
INPUT_DIR=$1; shift
OUTPUT_DIR=$1; shift


{ cd "$INPUT_DIR" && find . -mindepth 1 -maxdepth 1 -type d ; } |\
    parallel -j "$JOBS"\
    "$SWIPL" -q -f "$ELFAPP"/swiprolog.pl -g traverse_dir -t halt -- "$INPUT_DIR/{}" "$OUTPUT_DIR/{}" "$@"
