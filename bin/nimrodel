#!/bin/bash

. "${0%/*}/env"

exit_usage() {
    "$SWIPL" -q -f "$ELFAPP"/swiprolog.pl -g main -t halt -- "-help"
    exit 1
}

save_state() {
    "$SWIPL" -q -f "$ELFAPP"/swiprolog.pl -g save_state -t halt -- "$1"
}

call_nimrodel () {
    "$TCROOT/.nimrodel-image" "$@"
}

NIMRODEL_IMAGE=$TCROOT/.nimrodel-image
NIMRODEL_SAVED=$TCROOT/.nimrodel-saved

if [ $# -lt 1 ]; then
    exit_usage
fi

CMD=$1
shift

if [ ! -e "$NIMRODEL_IMAGE" ]; then
    echo >&2 'Saving nimrodel image for the first time...'
    save_state "$NIMRODEL_IMAGE"
    if [ -e "$TCROOT/.git" ]; then
        LAST_COMMIT=$(git rev-parse HEAD)
        echo "$LAST_COMMIT" > "$NIMRODEL_SAVED"
    fi
elif [ -e "$TCROOT/.git" ]; then
    LAST_COMMIT=$(git rev-parse HEAD)
    SAVED_COMMIT=$(cat "$NIMRODEL_SAVED")
    if [ "$SAVED_COMMIT" != "$LAST_COMMIT" ]; then
        echo >&2 'Nimrodel image seems to be out of date; regenerating...'
        save_state "$TCROOT/.nimrodel-image"
        echo "$LAST_COMMIT" > "$NIMRODEL_SAVED"
    fi
fi


case "$CMD" in
    string)
        call_nimrodel main "$@"
        ;;
    file)
        # undocumented because we still need to generalise this to accept flags
        call_nimrodel on_files "$@"
        ;;
    dir)
        call_nimrodel traverse_dir "$@"
        ;;
    parallel-dir)
        if [ $# -lt 3 ]; then
            exit_usage
        fi
        args=("$@")
        JOBS="${args[$((${#}-3))]}"
        INPUT_DIR="${args[$((${#}-2))]}"
        OUTPUT_DIR="${args[$((${#}-1))]}"
        POPPED="${@:1:$((${#}-3))}"
        { cd "$INPUT_DIR" && find . -mindepth 1 -maxdepth 1 -type d ; } |\
            parallel -j "$JOBS"\
            "$SWIPL" -q -f "$ELFAPP"/swiprolog.pl -g traverse_dir -t halt --\
                 "$POPPED" "$INPUT_DIR/{}" "$OUTPUT_DIR/{}"
        ;;
    selftest)
        "$SWIPL" -q -f "$ELFAPP"/../test/harness.pl -g main -t halt
        ;;
    *)
        if [ "$CMD" == "-version" -o "$CMD" == "-help" ]; then
            "$SWIPL" -q -f "$ELFAPP"/swiprolog.pl -g main -t halt -- "$CMD"
        else
            echo >&2 "Unknown command: $CMD"
            echo >&2
            exit_usage
        fi
esac
