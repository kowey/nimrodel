#!/bin/bash

. "${0%/*}/env"

exit_usage() {
    "$SWIPL" -q -f "$ELFAPP"/swiprolog.pl -g main -t halt -- "-help"
    exit 1
}

if [ $# -lt 1 ]; then
    exit_usage
fi

CMD=$1
shift

case "$CMD" in
   string)
        "$SWIPL" -q -f "$ELFAPP"/swiprolog.pl -g main -t halt -- "$@"
        ;;
    dir)
        "$SWIPL" -q -f "$ELFAPP"/swiprolog.pl -g traverse_dir -t halt -- "$@"
        ;;
    parallel-dir)
        if [ $# -lt 3 ]; then
            exit_usage
        fi
        JOBS=$1; shift
        INPUT_DIR=$1; shift
        OUTPUT_DIR=$1; shift
        { cd "$INPUT_DIR" && find . -mindepth 1 -maxdepth 1 -type d ; } |\
            parallel -j "$JOBS"\
            "$SWIPL" -q -f "$ELFAPP"/swiprolog.pl -g traverse_dir -t halt --\
                "$INPUT_DIR/{}" "$OUTPUT_DIR/{}" "$@"
        ;;
    selftest)
        "$SWIPL" -q -f "$ELFAPP"/../test/harness.pl -g main -t halt
        ;;
    *)
        if [ "$CMD" == "-version" -o "$CMD" == "-help" ]; then
            "$SWIPL" -q -f "$ELFAPP"/swiprolog.pl -g main -t halt -- "$CMD"
        else
            echo >&2 "Unknown command: $CMD"
            echo >&2
            exit_usage
        fi
esac
